/*
    Copyright 2011 Lunatech Research, Stephane Epardaud
    
    This file is part of stamps.js.

    stamps.js is free software: you can redistribute it and/or modify
    it under the terms of the GNU Lesser General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    stamps.js is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public License
    along with stamps.js.  If not, see <http://www.gnu.org/licenses/>.
*/
var Stamps={};
(function(){function i(a){window.console&&console.log(a)}function p(a,b){var c=a.constructor;if(Object.create)a.prototype=Object.create(b.prototype);else{var d=function(){};d.prototype=b.prototype;a.prototype=new d}a.prototype.constructor=c}function Q(a){this.expr=a}function R(a){this.code=a}function S(a){this.ref=a}function T(a,b){var c=C[a];if(!c)return new D(a,b);return new c(a,b)}function D(a,b){h.apply(this,[a,b])}function E(a,b){h.apply(this,[a,b])}function F(a,b){h.apply(this,[a,b])}function x(a,
b){h.apply(this,[a,b])}function y(a,b){h.apply(this,[a,b])}function z(a,b){h.apply(this,[a,b])}function G(a,b){h.apply(this,[a,b])}function H(a,b){h.apply(this,[a,b])}function I(a,b){h.apply(this,[a,b])}function J(a,b){h.apply(this,[a,b])}function K(a,b){h.apply(this,[a,b])}function U(a,b){h.apply(this,[a,b])}function V(){i("stamps autoprocess 2");i("loading tag templates");jQuery("[data-stamp=tag]").each(function(b,c){function d(m,e){var g={},j;for(j in e){var k;k=j.match(/^_/)?j:"_"+j;g[k]=e[j]}h.apply(this,
[m,g])}var f=jQuery(c),l=f.attr("name");if(!l)throw"Missing name on template tag";f=f.html();var o=L(f);u[l]=o;i("Defining new tag: "+o);p(d,h);d.prototype.outputInNewEnv=function(m,e,g){e={};var j=false,k;for(k in this.attributes){e[k]=g.evalExpression(this.attributes[k]);j=true}j&&g.declareVariables(e);g.pushContext("body",this);o.output(m,undefined,g);g.popContext("body")};s(l,d)});i("loading ref templates");jQuery("[data-stamp=ref]").each(function(b,c){var d=jQuery(c),f=d.attr("id");if(!f)throw"Missing ID on template reference";
d=d.html();i("Defining template ref "+f);u[f]=L(d)});i("resolving templates");for(var a in u)u[a].resolve();i("loading url templates");jQuery("[data-stamp-url]").each(function(b,c){var d=jQuery(c),f=d.attr("data-stamp-url");W(d,f)});i("loading inline templates");jQuery("[data-stamp=inline]").each(function(b,c){var d=jQuery(c),f=d.html();f=M(f);d.replaceWith(f)});i("running onready triggers");X=true;jQuery.each(Y,function(b,c){c()})}function W(a,b,c){jQuery.ajax({method:"GET",url:b,success:function(d){d=
M(d,c);a.html(d)},error:function(){alert("Failed to load template "+b)}})}function M(a,b){try{var c=L(a);c.resolve();return A(c,new q(b))}catch(d){i("Error: "+d)}}function L(a){i("parseTemplates1 for "+a.length+" characters");var b=new h("main"),c=undefined,d=undefined,f=undefined,l=undefined,o=[],m=false,e=0;i("parseTemplates for "+a.length+" characters");for(var g=0;g<a.length;g++){var j=a.charAt(g),k=g<a.length-1?a.charAt(g+1):undefined;if(!m&&(d||f||l)){if(j=="("){o.push(")");continue}if(j=="{"){o.push("}");
continue}if(j=="["){o.push("]");continue}if(o.length>0&&(j==")"||j=="]"||j=="}")){k=o.pop();if(!k)throw"Mismatched parent: unexpected "+j;if(k!=j)throw"Mismatched parent: unexpected "+j+" expecting: "+k;continue}}if(!m&&j==="!"&&k==="{"){b.addChild(a.substring(e,g));g++;c=g+1}else if(!m&&c!==undefined&&j==="}"&&k==="!"){c=a.substring(c,g);i("Got code: "+c);b.addChild(new R(c));g++;e=g+1;c=undefined}else if(!m&&j==="^"&&k==="{"){b.addChild(a.substring(e,g));g++;d=g+1}else if(!m&&d!==undefined&&j===
"}"){d=a.substring(d,g);i("Got expr: "+d);b.addChild(new Q(d));e=g+1;d=undefined}else if(!m&&j==="`"&&k==="{"){b.addChild(a.substring(e,g));g++;l=g+1}else if(!m&&l!==undefined&&j==="}"){l=a.substring(l,g);i("Got ref: "+l);b.addChild(new S(l));e=g+1;l=undefined}else if(j==="~"&&k==="{"){b.addChild(a.substring(e,g));g++;f=g+1}else if(f!==undefined&&j==="}"){e=a.substring(f,g);i("Got tag: "+e);i("parse tag: "+e);if(e.charAt(0)=="/"){k=e.match(/^\/([-a-zA-Z0-9_]+)\s*$/)[1];i("tag close for "+k);k=T(k);
k.isEnd=true}else{k=e.match(/^([-a-zA-Z0-9_]+)[ \/]?/)[1];i("tag name: "+k);e=jQuery.trim(e.substring(k.length));(j=!e.match(/\/$/))||(e=e.substring(0,e.length-1));var B={},n=[],Z=false,N=undefined,v=undefined,$=0;i("parse tag 1");for(var t=0;t<e.length;t++){var r=e.charAt(t);if(n.length==0&&r==":"){N=jQuery.trim(e.substring($,t));v=t+1}else if(n.length==0&&r==","){if(!v)throw"Invalid syntax: attribute name missing: "+e;B[N]=jQuery.trim(e.substring(v,t));Z=true;v=undefined;$=t+1}else if(r=="'")n[n.length-
1]=="'"?n.pop():n.push("'");else if(r=='"')n[n.length-1]=='"'?n.pop():n.push('"');else if(r=="(")n.push(")");else if(r=="{")n.push("}");else if(r=="[")n.push("]");else if(r==")"||r=="]"||r=="}"){var O=n.pop();if(!O)throw"Mismatched paren: unexpected "+r;if(O!=r)throw"Mismatched paren: unexpected "+r+" expecting: "+O;}}i("parse tag 2");if(v){if(n.length!=0)throw"Mismatched parent: forgot to close "+n.length+" parents";n=jQuery.trim(e.substring(v));B[N]=n}else if(e.length>0&&!Z){if(n.length!=0)throw"Mismatched parent: forgot to close "+
n.length+" parents";B._arg=e}k=T(k,B);k.isOpen=j;i("parse tag DONE: "+e)}e=k;if(e.isEnd){if(m)if(e.name=="noEval")m=false;else{e=f-2;f=undefined;continue}if(e.name!=b.name)throw"Invalid end tag "+e.name+" for current tag "+b.name;b=b.parent}else if(m){e=f-2;f=undefined;continue}else{b.addChild(e);e.parent=b;if(e.isOpen){b=e;if(b.name=="noEval")m=true}}e=g+1;f=undefined}}e<a.length&&b.addChild(a.substring(e));if(b.name!="main")throw"Bad current tag after parsing";i("parseTemplates done");return b}
function A(a,b){var c="";a.output(function(d){i("outputing "+d);c+=d},null,b);return c}function q(a){this.env=eval(aa("42"));this.context={};a&&this.declareVariables(a)}function aa(a,b){var c;c=b===true?"return ("+a+");":b?"return function(e){ "+b+" = e;};":a+"; return function(e, isExpr){ return eval(Stamps.__extendEnv(e, isExpr)); }";i("Eval: "+c);return"(function(){ "+c+" })()"}function w(a){var b=this;jQuery.ajax({method:"GET",url:a,success:function(c){b.dataReady(c)},error:function(){alert("Failed to load future from "+
a)}})}var P=0;Stamps.extend=p;Q.prototype.output=function(a,b,c){a(c.evalExpression(this.expr))};R.prototype.output=function(a,b,c){c.evalStatement(this.code)};var ba=Stamps.references={};Stamps.getReference=function(a){return ba[a]};S.prototype.output=function(a,b,c){b=c.evalExpression(this.ref);c="__stamps_"+P++;ba[c]=b;a("Stamps.getReference('"+c+"')")};var C={},s=Stamps.declareTag=function(a,b){C[a]=b},h=Stamps.Tag=function(a,b){this.name=a;this.children=[];this.attributes=b};h.prototype.addChild=
function(a){this.children.push(a)};h.prototype.output=function(a,b,c){c.preserve();this.outputInNewEnv(a,b,c);c.restore()};h.prototype.outputInNewEnv=function(a,b,c){this.recursiveOutput(a,c)};h.prototype.recursiveOutput=function(a,b){for(var c,d=0;d<this.children.length;d++){var f=this.children[d];if(typeof f=="string"){a(f);if(jQuery.trim(f).length>0)c=f}else{f.output(a,c,b);c=f}}};h.prototype.resolve=function(){for(var a=0;a<this.children.length;a++){var b=this.children[a];if(b instanceof h){if(b instanceof
D){var c;c=b.name;var d=C[c];if(!d)throw"Unknown tag: "+c;c=new d(c,b.attributes);c.children=b.children;this.children[a]=b=c}b.resolve()}}};p(D,h);p(E,h);E.prototype.outputInNewEnv=function(a,b,c){b=c.evalExpression(this.attributes.items);var d=c.evalExpression(this.attributes["var"]),f=d+"_list",l=d+"_index";c.evalStatement("var "+f+";");c.setVariable(f,b);for(f=0;f<b.length;f++){c.preserve();c.evalStatement("var "+l+", "+d+";");c.setVariable(l,f);c.setVariable(d,b[f]);this.recursiveOutput(a,c);
c.restore()}};p(F,h);F.prototype.outputInNewEnv=function(a,b,c){b=jQuery(c.evalExpression(this.attributes.selector));var d=c.evalExpression(this.attributes["var"]),f=d+"_jQuery",l=d+"_index";c.evalStatement("var "+f+";");c.setVariable(f,b);var o=this;b.each(function(m,e){c.preserve();c.evalStatement("var "+l+", "+d+";");c.setVariable(l,m);c.setVariable(d,jQuery(e));o.recursiveOutput(a,c);c.restore()})};p(x,h);x.prototype.outputInNewEnv=function(a,b,c){b=this.resumingFromFuture?this.resumingFromFuture:
c.evalExpression(this.attributes.value);if(b instanceof w){var d=b.getData();if(d)this.outputBody(a,c,d);else{var f="__stamps_"+P++,l=c.clone(),o=this;b.listen(function(m){var e=jQuery("#"+f);e.removeClass("stamps-waiter");o.resumingFromFuture=m;m=A(o,l);e.replaceWith(m)});a("<span class='stamps-waiter' id='"+f+"'>Loading...</span>")}}else this.outputBody(a,c,b)};x.prototype.outputBody=function(a,b,c){var d=b.evalExpression(this.attributes["var"]);b.evalStatement("var "+d);b.setVariable(d,c);this.recursiveOutput(a,
b)};p(y,h);y.prototype.outputInNewEnv=function(a,b,c){b=c.evalExpression(this.attributes._arg);var d="__stamps_"+P++,f=c.clone(),l=this.evalBody(f),o=this;i("Timer of: "+b+", id:  "+d);window.setInterval(function(){i("Timer tick: "+d);var m=jQuery("#"+d),e=o.evalBody(f);if(e!=l){i("Timer replacing output");m=jQuery("#"+d);m.html(e);l=e}},b);a("<span class='stamps-timer' id='"+d+"'>"+l+"</span>")};y.prototype.evalBody=function(a){var b="";this.recursiveOutput(function(c){b+=c},a);return b};p(z,h);
z.prototype.outputInNewEnv=function(a,b,c){this.testMatched=c.evalExpression(this.attributes._arg);i("if "+this.attributes._arg+" yielded "+this.testMatched);this.testMatched&&this.recursiveOutput(a,c)};p(G,h);G.prototype.outputInNewEnv=function(a,b,c){if(!(b instanceof z))throw"Invalid else: missing if";b.testMatched||this.recursiveOutput(a,c)};p(H,h);H.prototype.outputInNewEnv=function(a,b,c){var d=a;b=c.getContext("body");if(!b)throw"Invalid doBody tag: not invoked via simple tag";if(this.attributes.escape)if(c.evalExpression(this.attributes.escape))a=
function(f){d(f.replace(/</g,"&lt;"))};b.recursiveOutput(a,c)};p(I,h);I.prototype.outputInNewEnv=function(a){a("<\/script>")};p(J,h);J.prototype.outputInNewEnv=function(a,b,c){b=c.evalExpression(this.attributes._arg);a("~{/"+b+"}")};p(K,h);K.prototype.outputInNewEnv=function(a,b,c){b=c.evalExpression(this.attributes._arg);a("~{"+b+"}")};p(U,h);s("if",z);s("else",G);s("list",E);s("jQuery",F);s("future",x);s("timer",y);s("doBody",H);s("closeScript",I);s("closeTag",J);s("openTag",K);s("noEval",U);var u=
{},Y=[],X=false;Stamps.ready=function(a){X?a():Y.push(a)};Stamps.loadTemplate=function(a,b,c){jQuery("#"+a).Stamps(b,c)};Stamps.applyTemplate=function(a,b){a=u[a];if(!a)throw"Invalid template id: "+params.id;return A(a,new q(b))};jQuery.fn.Stamps=function(a,b){if(a.url)W(this,a.url,b);else if(a.id){var c=u[a.id];if(!c)throw"Invalid template id: "+a.id;this.html(A(c,new q(b)))}else throw"Invalid or missing argument, expecting id or url";};jQuery(function(){i("stamps autoprocess 1");var a=jQuery("link[rel=stamps]");
if(a.size()==0)V();else{var b=a.size(),c=function(d){jQuery("body").append(d);b--;b==0&&V()};a.each(function(d,f){var l=jQuery(f);jQuery.ajax({url:l.attr("href"),method:"GET",success:c,error:function(){alert("Failed to load autotag "+l.attr("href"))}})})}});Stamps.__processTemplates=M;q.prototype.declareVariables=function(a){var b="var ",c;for(c in a){if(b.length>4)b+=", ";b+=c}b+=";";this.evalStatement(b);for(c in a)this.setVariable(c,a[c])};q.prototype.pushContext=function(a,b){this.context[a]||
(this.context[a]=[]);this.context[a].push(b)};q.prototype.popContext=function(a){var b=this.context[a];if(!b)throw"No such context: "+a;return b.pop()};q.prototype.getContext=function(a){var b=this.context[a];if(!b)throw"No such context: "+a;return b[b.length-1]};q.prototype.preserve=function(){this.pushContext("environment",this.env)};q.prototype.restore=function(){this.env=this.popContext("environment")};q.prototype.clone=function(){var a=new q;a.env=this.env;a.context={};for(var b in this.context)a.context[b]=
this.context[b].concat();return a};q.prototype.evalStatement=function(a){this.env=this.env(a)};q.prototype.evalExpression=function(a){try{return this.env(a,true)}catch(b){if(!(b instanceof ReferenceError))throw b;}};q.prototype.setVariable=function(a,b){this.env(b,a)(b)};Stamps.__extendEnv=aa;Stamps.Future=w;w.prototype.dataReady=function(a){if(this.receiver)this.receiver(a);else this.data=a};w.prototype.getData=function(){return this.data};w.prototype.listen=function(a){this.receiver=a}})();
